#!/usr/bin/env bash

set -o errexit     # Exit immediately if a command exits with a non-zero status.
set -o nounset     # Treat unset variables as an error.
set -o pipefail    # If any command in a pipeline fails, that return code is used.
if [[ "${TRACE-0}" == "1" ]]; then
    set -o xtrace  # Print commands and their arguments as they are executed (for debugging).
fi

# Ensure that the correct environment (BASH, not sh or another shell) is running
# This prevents errors if the script is invoked incorrectly (e.g., 'sh script.sh')
if [[ -z "${BASH_VERSION}" ]]; then
    echo "Error: This script requires Bash to run." >&2
    exit 1
fi

SCRIPT_NAME="$(basename "$0")"
readonly SCRIPT_NAME

# Move into the directory containing the script.
# This ensures all relative paths referenced within the script are correct.
# Note: It uses the directory of the SCRIPT being EXECUTED, not the sourced file.
cd "$(dirname "$0")" || exit 1

# shellcheck source=/dev/null
source "$HOME/.config/shell/lib/functions.sh" || exit 1

usage() {
    echo "Usage:"
    echo "    $SCRIPT_NAME help:"
    echo "        Show this help message"
    echo "    $SCRIPT_NAME update:"
    echo "        Update Firefox Default profile with my overrides"
    echo "    $SCRIPT_NAME cleanup:"
    echo "        Cleanup Firefox Default profile overrides"
    echo "    $SCRIPT_NAME show:"
    echo "        Show path to profile, does not do any changes"
    echo
    echo "    e.g: $SCRIPT_NAME update"
    echo "    e.g: $SCRIPT_NAME cleanup"
    echo
    exit "$1"
}

firefox_default_profile() {
    local PROFILE_DIR PROFILE_NAME PROFILE

    # flatpak firefox takes precedence
    if [ -d "$HOME"/.var/app/org.mozilla.firefox/.mozilla/firefox ]; then
        PROFILE_DIR="$HOME"/.var/app/org.mozilla.firefox/.mozilla/firefox
    else
        PROFILE_DIR="$HOME"/.mozilla/firefox
    fi
    [ -z "$PROFILE_DIR" ] && usage 1

    PROFILE_NAME=$(grep "Default=.*\.default*" "$PROFILE_DIR/profiles.ini" | cut -d"=" -f2)
    [ -z "$PROFILE_NAME" ] && usage 1

    PROFILE="$PROFILE_DIR/$PROFILE_NAME"
    [ -d "$PROFILE" ] || usage 1

    echo "$PROFILE"
}

show() {
    local PROFILE
    if pgrep firefox > /dev/null; then
        echo ">>> Firefox is running. Close Firefox and try again."
        usage 1
    fi

    PROFILE=$(firefox_default_profile)
    test $? -eq 0 || usage 1
    echo ">>> Firefox profile: $PROFILE"
}

cleanup() {
    local PROFILE
    if pgrep firefox > /dev/null; then
        echo ">>> Firefox is running. Close Firefox and try again."
        usage 1
    fi

    PROFILE=$(firefox_default_profile)
    test $? -eq 0 || usage 1
    echo ">>> Cleaning 'user.js' file for $PROFILE"

    [ -f "${PROFILE}"/user.js ] && rm -f "${PROFILE}"/user.js
    [ -f "${PROFILE}"/user-overrides.js ] && rm -f "${PROFILE}"/user-overrides.js

    echo "All done!"
    echo
}

update() {
    local PROFILE
    if pgrep firefox > /dev/null; then
        echo ">>> Firefox is running. Close Firefox and try again."
        usage 1
    fi

    PROFILE=$(firefox_default_profile)
    test $? -eq 0 || usage 1
    echo ">>> Updating 'user.js' file for $PROFILE"

    # Cleanup
    [ -f "${PROFILE}"/user.js ] && rm -f "${PROFILE}"/user.js
    [ -f "${PROFILE}"/user-overrides.js ] && rm -f "${PROFILE}"/user-overrides.js

    # Get latest
    curl -o "${PROFILE}"/user.js https://raw.githubusercontent.com/yokoffing/Betterfox/main/user.js
    test $? -eq 0 || usage 1

    [ ! -f "${PROFILE}"/user.js ] && usage 1

    # Use sed to find the marker line and read the new content from a here document
    # The -i.bak flag edits the file in-place and creates a backup named file.js.bak
    sed -i.bak "/\/\/ Enter your personal overrides below this line:/r /dev/stdin" "${PROFILE}"/user.js <<'EOF'

// Re-enables 'about:home' page for startup landing page and new tabs
user_pref("browser.startup.page", 1);
user_pref("browser.startup.homepage", "about:home");
user_pref("browser.newtabpage.enabled", true);
user_pref("browser.newtab.preload", true);

// Disables Pocket extension
user_pref("extensions.pocket.enabled", false);

// Make tabbar height smaller
user_pref("browser.uidensity", 1);

// Disable show menu on ALT press
user_pref("ui.key.menuAccessKeyFocuses", false);

// Enable container tabs
user_pref("privacy.userContext.enabled", true);

// Disable weather on New Tab page
user_pref("browser.newtabpage.activity-stream.showWeather", false);
user_pref("browser.newtabpage.activity-stream.system.showWeather", false);

// Don't like this behaviour (just cycle in order)
user_pref("browser.ctrlTab.sortByRecentlyUsed", false)

// Disable login manager
user_pref("signon.rememberSignons", false);

// Disable pop-up to save logins for a new site
user_pref("signon.formlessCapture.enabled", false);

// Disable address and credit card manager
user_pref("extensions.formautofill.addresses.enabled", false);
user_pref("extensions.formautofill.creditCards.enabled", false);

// Do not allow embedded tweets, Instagram, Reddit, and Tiktok posts
user_pref("urlclassifier.trackingSkipURLs", "");
user_pref("urlclassifier.features.socialtracking.skipURLs", "");

// Enable HTTPS-Only Mode
user_pref("dom.security.https_only_mode", true);
user_pref("dom.security.https_only_mode_error_page_user_suggestions", true);

// Set DNS-over-HTTPS (DoH) provider
user_pref("network.trr.uri", "https://dns.quad9.net/dns-query");

// Enforce DoH
user_pref("network.trr.mode", 3);

// DoH Excluded domains (comma separated list of domains)
user_pref("network.trr.excluded-domains", "goldfinger.omidev.net");

// Run on the GPU
user_pref("layers.acceleration.force-enabled", true);

// 1=always block, 2=you want to be prompted for every site that tries to autoplay
user_pref("media.autoplay.default", 1);

// Do not use disk for caches
user_pref("browser.cache.disk.enable", false)

// Revert back to Standard ETP - Most problems stem from Firefox running in Strict mode
user_pref("browser.contentblocking.category", "standard");

// Allow websites to ask you to receive site notifications - I need this for slack!
user_pref("permissions.default.desktop-notification", 0);

/* END: internal custom pref to test for syntax errors ***/
user_pref("_user.js.parrot", "SUCCESS: No no he's not dead, he's, he's restin'!");
EOF
    test $? -eq 0 || usage 1

    echo "All done!"
    echo
}

main() {
    nargs=$#
    cmd=${1-}
    rc=0
    if [ "$#" -gt 0 ]; then shift; fi
    case $cmd in
        update)
            [ "$nargs" -eq 1 ] || usage 1
            update "$@"
            ;;
        cleanup)
            [ "$nargs" -eq 1 ] || usage 1
            cleanup "$@"
            ;;
        show)
            [ "$nargs" -eq 1 ] || usage 1
            show "$@"
            ;;
        help | --help | -h)
            usage 0
            ;;
        *)
            usage 1
            ;;
    esac
    return $rc
}

main "$@"
